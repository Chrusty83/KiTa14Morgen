<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gästeliste & Mitbringsel</title>
  <style>
    body{font-family:sans-serif;background:#f5f7fa;color:#222;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;margin:0;padding:40px;}
    .wrap{max-width:800px;width:100%;background:white;padding:24px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
    h1{margin-top:0;text-align:center;}
    form{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;margin-bottom:16px;}
    input,button{padding:10px;border-radius:8px;border:1px solid #ccc;font-size:15px;}
    button{cursor:pointer;background:#007bff;color:white;border:none;}
    button:hover{background:#0056b3;}
    .list{margin-top:16px;}
    .item{border-bottom:1px solid #eee;padding:8px 0;display:flex;justify-content:space-between;align-items:center;}
    .name{font-weight:bold;}
    .bring{color:#555;}
    .actions button{margin-left:6px;background:#e0e0e0;color:#333;}
    .actions button:hover{background:#ccc;}
    footer{text-align:center;margin-top:20px;font-size:13px;color:#666;}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Gästeliste & Mitbringsel</h1>

    <form id="entryForm">
      <input id="nameInput" placeholder="Name" required />
      <input id="bringInput" placeholder="Mitbringsel" required />
      <button>Hinzufügen</button>
    </form>

    <div class="list" id="listContainer"></div>

    <footer>
      <button id="exportBtn">Export (JSON)</button>
      <button id="saveBtn">In GitHub speichern</button>
      <div id="status"></div>
    </footer>
  </div>

  <script>
    const listContainer = document.getElementById('listContainer');
    const form = document.getElementById('entryForm');
    const nameInput = document.getElementById('nameInput');
    const bringInput = document.getElementById('bringInput');
    const exportBtn = document.getElementById('exportBtn');
    const saveBtn = document.getElementById('saveBtn');
    const status = document.getElementById('status');

    const PROXY_URL = 'https://workerbring1.christian-63a.workers.dev/';

    let entries = [];

    async function loadData(){
      try {
        const res = await fetch('https://raw.githubusercontent.com/Chrusty83/KiTa14Morgen/main/data.json');
        if(res.ok){entries = await res.json(); render();}
      } catch(e){console.log('Keine Daten geladen', e);}
    }

    function render(){
      listContainer.innerHTML = '';
      if(entries.length===0){
        listContainer.innerHTML = '<p>Noch keine Einträge.</p>';
        return;
      }
      entries.forEach((e,i)=>{
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<div><div class="name">${escapeHtml(e.name)}</div><div class="bring">${escapeHtml(e.bring)}</div></div>`+
                        `<div class="actions"><button data-del="${i}">Löschen</button></div>`;
        listContainer.appendChild(div);
      });
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }

    form.addEventListener('submit',ev=>{
      ev.preventDefault();
      const n=nameInput.value.trim();
      const b=bringInput.value.trim();
      if(!n||!b)return;
      entries.push({name:n,bring:b});
      form.reset();
      render();
    });

    listContainer.addEventListener('click',ev=>{
      const del=ev.target.closest('[data-del]');
      if(del){entries.splice(parseInt(del.dataset.del),1);render();}
    });

    exportBtn.addEventListener('click',()=>{
      const blob=new Blob([JSON.stringify(entries,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');a.href=url;a.download='gaesteliste.json';a.click();URL.revokeObjectURL(url);
    });

    saveBtn.addEventListener('click',async()=>{
      status.textContent='Speichere in GitHub...';
      try {
        const res = await fetch(PROXY_URL,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({entries})
        });
        status.textContent = res.ok ? 'Gespeichert!' : 'Fehler beim Speichern ('+res.status+')';
      } catch(e){
        status.textContent='Fehler: '+e.message;
      }
    });

    loadData();
  </script>
</body>
</html>
